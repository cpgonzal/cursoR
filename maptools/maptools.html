<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="http://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="http://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js.gz"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="../Slidy2/styles/slidy.css" />
  <script src="../Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>

<style type="text/css">


#head-logo {
  margin: 0;
  margin-top: -0.1em;
  padding-top: 0.25em;
  padding-bottom: 0.2em;
  padding-left: 0;
  padding-right: 0;
  height: 3.2em;
  width: 4.8em;
  float: right;
  z-index: 2;
  background: #FFFFFF;
}

#head-icon1 {
  margin-top: 0.5em;
  margin-bottom: 0;
  margin-left: 0;
  margin-right: 1em;
  /*background:  #728ec2;*/
  border-width: 0;
  height: 1em;
  max-width: 3em;
  z-index: 2;
  float: left;
}


div.background {
  z-index: 1;
  position: relative;
  vertical-align: bottom;
  left: 0;
  right: 0;
  top: 0;
  bottom: auto;
  height: 4.1em;
  padding: 0 0 0 0.2em;
  margin: 0 0 0 0;
  border-width: 0;
  background-color: #FFFFFF;
}


</style>


<div class="background"> 
  <img id="head-icon" alt="R logo" height="15"
    src="../assets/img/Rlogo.jpg" /> 
			
   <object id="head-logo" >
        <img id="head-logo" style="height: 0.8em; width: 6.0em;" src="../assets/img/logo_FG_ULL.png" alt="Fundación General de la Universidad de La Laguna" />
        <img id="head-logo" style="height: 0.6em; width: 3.0em;" src="../assets/img/logo_istac.jpg" alt="ISTAC - Instituto Canario de Estadística" />
</object>

</div> 
<div id="la-librería-maptools" class="slide section level2">
<h1>La librería maptools</h1>
<ol class="incremental" style="list-style-type: decimal">
<li>Esta librería es un conjunto de herramientas para leer y manejar objetos espaciales.</li>
<li>En particular, permite cargar archivos ESRI shapefiles (.shp).</li>
<li>Esta librería se suele utilizar en combinación con otras: sp (clases y métodos para datos geo-espaciales), RColorBrewer (paletas de colores) y ggplot2 (libraría gráfica). <br> Website (blog): http://rspatialtips.org.uk/ <br> Tutorial: https://dl.dropbox.com/u/9577903/broomspatial.pdf</li>
</ol>
</div>
<div id="la-librería-maptools-1" class="slide section level2">
<h1>La librería maptools</h1>
<p>Cargamos los archivos de las 27 comarcas de canarias:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(maptools)
canary.counties &lt;-<span class="st"> </span><span class="kw">readShapeLines</span>(<span class="dt">fn =</span> <span class="st">&quot;ISTAC_comarcas27_R.shp&quot;</span>)
<span class="kw">plot</span>(canary.counties, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/loadmap03.png" />
</div>
</div>
<div id="la-librería-maptools-2" class="slide section level2">
<h1>La librería maptools</h1>
<p>Vamos a cargar el mapa en forma de polígonos (Poly Shape):</p>
<pre class="sourceCode r"><code class="sourceCode r">canary.counties &lt;-<span class="st"> </span><span class="kw">readShapePoly</span>(<span class="dt">fn =</span> <span class="st">&quot;ISTAC_comarcas27_R.shp&quot;</span>)
<span class="kw">plot</span>(canary.counties, <span class="dt">axes =</span> <span class="ot">TRUE</span>, <span class="dt">col =</span> <span class="st">&quot;red&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/loadmap06.png" />
</div>
</div>
<div id="la-librería-maptools-3" class="slide section level2">
<h1>La librería maptools</h1>
<p>Para examinar el objeto canary.counties que hemos cargado:</p>
<pre class="sourceCode r"><code class="sourceCode r">canary.counties
<span class="kw">summary</span>(canary.counties)

<span class="kw">slotNames</span>(canary.counties)
canary.counties@data
canary.counties@polygons[[<span class="dv">1</span>]]</code></pre>
<p>Observamos que los ejes representados no corresponden a las escalas de latitud y longitud de un mapa:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(<span class="kw">proj4string</span>(canary.counties))
<span class="kw">proj4string</span>(canary.counties) &lt;-<span class="st"> &quot;+proj=longlat +datum=WGS84&quot;</span>
<span class="kw">print</span>(<span class="kw">proj4string</span>(canary.counties))
<span class="kw">plot</span>(canary.counties, <span class="dt">axes =</span> <span class="ot">TRUE</span>)</code></pre>
</div>
<div id="la-librería-maptools-4" class="slide section level2">
<h1>La librería maptools</h1>
<p>Para representar una variable en un mapa, lo más común es asociar al slot “data” los valores de la variable utilizando el comando merge(). Por ejemplo:</p>
<pre class="sourceCode r"><code class="sourceCode r">censal.hombres &lt;-<span class="st"> </span>data.comarcas.censal[data.comarcas.censal$sexo ==<span class="st"> &quot;men&quot;</span>, ]
canary.tmp &lt;-<span class="st"> </span><span class="kw">merge</span>(canary.counties@data, censal.hombres, <span class="dt">by.x =</span> <span class="st">&quot;CODCOM&quot;</span>, <span class="dt">by.y =</span> <span class="st">&quot;comarca&quot;</span>, 
    <span class="dt">sort =</span> <span class="ot">FALSE</span>)
canary.counties@data$sexoH &lt;-<span class="st"> </span>canary.tmp$sexo
canary.counties@data$censoH &lt;-<span class="st"> </span>canary.tmp$censo</code></pre>
<p>Tambien se puede utilizar el comando match(). Por ejemplo:</p>
<pre class="sourceCode r"><code class="sourceCode r">censal.mujeres &lt;-<span class="st"> </span>data.comarcas.censal[data.comarcas.censal$sexo ==<span class="st"> &quot;women&quot;</span>, 
    ]
idx &lt;-<span class="st"> </span><span class="kw">match</span>(canary.counties@data$CODCOM, censal.mujeres$comarca)
canary.counties@data$sexoM &lt;-<span class="st"> </span>censal.mujeres$sexo[idx]
canary.counties@data$censoM &lt;-<span class="st"> </span>censal.mujeres$censo[idx]</code></pre>
</div>
<div id="la-librería-maptools-5" class="slide section level2">
<h1>La librería maptools</h1>
<p>Para representar un mapa de intensidad, necesitamos definir una paleta de colores y luego el comando spplot();</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(classInt)
<span class="kw">library</span>(RColorBrewer)
n =<span class="st"> </span><span class="dv">7</span>
<span class="co"># obtener una paleta de 7 colores</span>
pal &lt;-<span class="st"> </span><span class="kw">brewer.pal</span>(n, <span class="st">&quot;Blues&quot;</span>)
<span class="co"># obtener intervalos de clase para 7 colores</span>
int &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(canary.counties@data$censoH, n, <span class="dt">style =</span> <span class="st">&quot;jenks&quot;</span>)

p &lt;-<span class="st"> </span><span class="kw">spplot</span>(canary.counties[<span class="st">&quot;censoH&quot;</span>], <span class="dt">col.regions =</span> pal, <span class="dt">at =</span> <span class="kw">signif</span>(int$brks, 
    <span class="dt">digits =</span> <span class="dv">2</span>), <span class="dt">lwd =</span> <span class="fl">0.4</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)
p</code></pre>
<div class="figure">
<img src="figure/loadmap10.png" />
</div>
</div>
<div id="la-librería-maptools-6" class="slide section level2">
<h1>La librería maptools</h1>
<p>La comarca con menor valor del censo se puede quedar de color blanco:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># corrección del primer color de la escala</span>
int$brks[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">1000</span>
<span class="co"># comprobar el orden de representación</span>
canary.counties@data[<span class="kw">order</span>(canary.counties@data$censoH), ]</code></pre>
<p>Podemos utilizar otras paletas:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Paletas</span>

<span class="co"># display.brewer.pal(n, &#39;Blues&#39;)</span>
<span class="kw">pie</span>(<span class="kw">rep</span>(<span class="dv">1</span>, n), <span class="dt">col =</span> <span class="kw">brewer.pal</span>(n, <span class="st">&quot;Blues&quot;</span>))
<span class="kw">pie</span>(<span class="kw">rep</span>(<span class="dv">1</span>, n), <span class="dt">col =</span> <span class="kw">brewer.pal</span>(n, <span class="st">&quot;YlOrRd&quot;</span>))
<span class="kw">pie</span>(<span class="kw">rep</span>(<span class="dv">1</span>, n), <span class="dt">col =</span> <span class="kw">heat.colors</span>(n))
<span class="kw">pie</span>(<span class="kw">rep</span>(<span class="dv">1</span>, n), <span class="dt">col =</span> <span class="kw">terrain.colors</span>(n))</code></pre>
</div>
<div id="la-librería-maptools-7" class="slide section level2">
<h1>La librería maptools</h1>
<pre class="sourceCode r"><code class="sourceCode r">pal &lt;-<span class="st"> </span><span class="kw">heat.colors</span>(n)
p &lt;-<span class="st"> </span><span class="kw">spplot</span>(canary.counties[<span class="st">&quot;censoH&quot;</span>], <span class="dt">col.regions =</span> pal, <span class="dt">at =</span> <span class="kw">signif</span>(int$brks, 
    <span class="dt">digits =</span> <span class="dv">2</span>), <span class="dt">lwd =</span> <span class="fl">0.4</span>, <span class="dt">col =</span> <span class="st">&quot;black&quot;</span>)
p</code></pre>
<div class="figure">
<img src="figure/loadmap12a.png" />
</div>
</div>
<div id="la-librería-maptools-8" class="slide section level2">
<h1>La librería maptools</h1>
<p>Se pueden utilizar otros métodos para los intervalos de clase:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Intervalos de clase</span>
int &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(canary.counties@data$censoH, n, <span class="dt">style =</span> <span class="st">&quot;quantile&quot;</span>)
int &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(canary.counties@data$censoH, n, <span class="dt">style =</span> <span class="st">&quot;pretty&quot;</span>)
int &lt;-<span class="st"> </span><span class="kw">classIntervals</span>(canary.counties@data$censoH, n, <span class="dt">style =</span> <span class="st">&quot;jenks&quot;</span>)</code></pre>
</div>
<div id="la-librería-maptools-9" class="slide section level2">
<h1>La librería maptools</h1>
<p>Podemos utilizar otros métodos de representación, plot() + legend():</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Representaciones alternativas</span>
<span class="kw">plot</span>(canary.counties, <span class="dt">col =</span> pal[<span class="kw">findInterval</span>(canary.counties@data$censoH, int$brks, 
    <span class="dt">all.inside =</span> <span class="ot">TRUE</span>)], <span class="dt">axes =</span> <span class="ot">TRUE</span>)
<span class="kw">legend</span>(<span class="dt">x =</span> -<span class="dv">18</span>, <span class="dt">y =</span> <span class="fl">30.5</span>, <span class="dt">legend =</span> <span class="kw">leglabs</span>(<span class="kw">round</span>(int$brks)), <span class="dt">cex =</span> <span class="fl">0.9</span>, <span class="dt">fill =</span> pal, 
    <span class="dt">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="dt">x.intersp =</span> <span class="fl">0.5</span>)</code></pre>
<div class="figure">
<img src="figure/loadmap13a.png" />
</div>
</div>
<div id="la-librería-maptools-10" class="slide section level2">
<h1>La librería maptools</h1>
<p>Otros métodos de representación, fortify()+ggplot2():</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Otra mas</span>
<span class="kw">library</span>(ggplot2)

<span class="co"># convertir el objeto &#39;SpatialPolygons&#39; en data.frame</span>
canary.fort &lt;-<span class="st"> </span><span class="kw">fortify</span>(canary.counties, <span class="dt">region =</span> <span class="st">&quot;IDCOM27&quot;</span>)
<span class="kw">head</span>(canary.fort)

canary.fort &lt;-<span class="st"> </span><span class="kw">merge</span>(canary.fort, canary.counties@data[, <span class="kw">c</span>(<span class="st">&quot;IDCOM27&quot;</span>, <span class="st">&quot;censoH&quot;</span>)], 
    <span class="dt">by.x =</span> <span class="st">&quot;id&quot;</span>, <span class="dt">by.y =</span> <span class="st">&quot;IDCOM27&quot;</span>, <span class="dt">sort =</span> <span class="ot">FALSE</span>)

<span class="kw">ggplot</span>(<span class="dt">data =</span> canary.fort, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group)) +<span class="st"> </span><span class="kw">geom_polygon</span>(<span class="dt">colour =</span> <span class="st">&quot;black&quot;</span>, 
    <span class="dt">fill =</span> <span class="st">&quot;white&quot;</span>)</code></pre>
</div>
<div id="la-librería-maptools-11" class="slide section level2">
<h1>La librería maptools</h1>
<p>Entonces:</p>
<pre class="sourceCode r"><code class="sourceCode r">map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> canary.fort, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group, <span class="dt">fill =</span> censoH)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_polygon</span>() +<span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>)
map</code></pre>
<div class="figure">
<img src="figure/loadmap14a.png" />
</div>
</div>
<div id="la-librería-maptools-12" class="slide section level2">
<h1>La librería maptools</h1>
<p>Otras variantes con ggplot2():</p>
<pre class="sourceCode r"><code class="sourceCode r">map +<span class="st"> </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;black&quot;</span>)

map +<span class="st"> </span><span class="kw">scale_fill_gradient</span>(<span class="dt">name =</span> <span class="st">&quot;censo&quot;</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">10000</span>, <span class="dv">50000</span>, <span class="dv">90000</span>))

map +<span class="st"> </span><span class="kw">scale_fill_gradientn</span>(<span class="dt">colours =</span> <span class="kw">brewer.pal</span>(<span class="dv">7</span>, <span class="st">&quot;Blues&quot;</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">1000</span>, 
    <span class="fl">1e+05</span>))</code></pre>
</div>
<div id="la-librería-maptools-13" class="slide section level2">
<h1>La librería maptools</h1>
<p>Podemos utilizar escalas discretas en el gráfico:</p>
<pre class="sourceCode r"><code class="sourceCode r">canary.fort$censoH.discreto &lt;-<span class="st"> </span><span class="kw">cut</span>(canary.fort$censoH, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">3000</span>, 
    <span class="dv">6000</span>, <span class="dv">9000</span>, <span class="dv">12000</span>, <span class="dv">15000</span>, <span class="dv">18000</span>, <span class="dv">21000</span>, <span class="ot">Inf</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;1000-3000&quot;</span>, <span class="st">&quot;3000-6000&quot;</span>, 
    <span class="st">&quot;6000-9000&quot;</span>, <span class="st">&quot;9000-12000&quot;</span>, <span class="st">&quot;12000-15000&quot;</span>, <span class="st">&quot;15000-18000&quot;</span>, <span class="st">&quot;18000-21000&quot;</span>, 
    <span class="st">&quot;&gt;21000&quot;</span>), <span class="dt">include.lowest =</span> <span class="ot">TRUE</span>)

<span class="kw">head</span>(canary.fort)</code></pre>
</div>
<div id="la-librería-maptools-14" class="slide section level2">
<h1>La librería maptools</h1>
<p>Entonces:</p>
<pre class="sourceCode r"><code class="sourceCode r">map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> canary.fort, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group, <span class="dt">fill =</span> censoH.discreto)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_polygon</span>() +<span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>)

map</code></pre>
<div class="figure">
<img src="figure/loadmap15a.png" />
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># map + scale_fill_brewer(&#39;Censo hombres total&#39;)</span></code></pre>
</div>
<div id="la-librería-maptools-15" class="slide section level2">
<h1>La librería maptools</h1>
<p>Podemos representar las comarcas de una isla:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># canary.counties@data[canary.counties@data$CODISLA==&#39;GC&#39;,]</span>
idx &lt;-<span class="st"> </span>canary.fort$id %in%<span class="st"> </span>canary.counties@data[canary.counties@data$CODISLA ==<span class="st"> </span>
<span class="st">    &quot;GC&quot;</span>, <span class="st">&quot;IDCOM27&quot;</span>]
canary.fort2 &lt;-<span class="st"> </span>canary.fort[idx, ]

map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> canary.fort2, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group, <span class="dt">fill =</span> censoH.discreto)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_polygon</span>() +<span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>)

map</code></pre>
<div class="figure">
<img src="figure/loadmap16a.png" />
</div>
</div>
<div id="la-librería-maptools-16" class="slide section level2">
<h1>La librería maptools</h1>
<p>Podemos representar con ggplot:</p>
<pre class="sourceCode r"><code class="sourceCode r">canary.fort &lt;-<span class="st"> </span><span class="kw">merge</span>(canary.fort, canary.counties@data[, <span class="kw">c</span>(<span class="st">&quot;IDCOM27&quot;</span>, <span class="st">&quot;IDPROV&quot;</span>, 
    <span class="st">&quot;PROV&quot;</span>, <span class="st">&quot;CODISLA&quot;</span>, <span class="st">&quot;ISLA&quot;</span>)], <span class="dt">by.x =</span> <span class="st">&quot;id&quot;</span>, <span class="dt">by.y =</span> <span class="st">&quot;IDCOM27&quot;</span>, <span class="dt">sort =</span> <span class="ot">FALSE</span>)

idx &lt;-<span class="st"> </span>canary.fort$id %in%<span class="st"> </span>canary.counties@data[canary.counties@data$PROV ==<span class="st"> </span>
<span class="st">    &quot;Santa Cruz de Tenerife&quot;</span>, <span class="st">&quot;IDCOM27&quot;</span>]

canary.fort2 &lt;-<span class="st"> </span>canary.fort[idx, ]

map &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> canary.fort2, <span class="kw">aes</span>(long, lat, <span class="dt">group =</span> group, <span class="dt">fill =</span> censoH.discreto)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_polygon</span>() +<span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">&quot;white&quot;</span>)

map +<span class="st"> </span><span class="kw">facet_grid</span>(PROV ~<span class="st"> </span>ISLA, <span class="dt">scales =</span> <span class="st">&quot;free_x&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/loadmap17a.png" />
</div>
</div>
</body>
</html>
